#
# $Id: Makefile.in,v 1.2 2006-04-27 08:53:26 shirok Exp $
#

# General info
SHELL       = @SHELL@
prefix      = @prefix@
exec_prefix = @exec_prefix@
bindir      = @bindir@
libdir      = @libdir@
srcdir      = @srcdir@
datadir     = @datadir@
datarootdir = @datarootdir@
VPATH       = $(srcdir)
top_srcdir  = @top_srcdir@

# These may be overridden by make invocators
DESTDIR        =
GOSH           = "@GOSH@"
GAUCHE_CONFIG  = "@GAUCHE_CONFIG@"
GAUCHE_PACKAGE = "@GAUCHE_PACKAGE@"
GAUCHE_CESCONV = "@GAUCHE_CESCONV@"
INSTALL        = "@GAUCHE_INSTALL@"

# Other parameters
ALL_LINGUAS = @ALL_LINGUAS@

PO_FILES = $(addsuffix .po,$(ALL_LINGUAS))
MO_FILES = $(addsuffix .gmo,$(ALL_LINGUAS))

MSGDIR = "$(DESTDIR)$(datadir)/locale/$$lingua/LC_MESSAGES/"

POTFILES = src/wiliki.scm \
           src/wiliki/db.scm \
           src/wiliki/edit.scm \
           src/wiliki/format.scm \
           src/wiliki/history.scm \
           src/wiliki/log.scm \
           src/wiliki/macro.scm \
           src/wiliki/page.scm \
           src/wiliki/parse.scm \
           src/wiliki/pasttime.scm \
           src/wiliki/rss.scm \
           src/wiliki/rssmix.scm \
           src/wiliki/util.scm

CONVDIR = conv1001

# Module-specific stuff
PACKAGE   = WiLiKi

# Rules

TARGET = $(MO_FILES)

.SUFFIXES: .po .gmo

.po.gmo:
	msgfmt -o $@ $<

all : $(TARGET)

# NB: xgettext doesn't recognize Gauche's extensional syntax.
# So we replace them before processing.
generate-pot:
	for f in $(POTFILES); do                               \
	  mkdir -p `dirname "$(CONVDIR)/$$f"`;                 \
	  cp -f $(top_srcdir)/$$f $(CONVDIR)/$$f;              \
	  sed -i -e 's@#"@"@g' $(CONVDIR)/$$f;                 \
	  sed -i -E 's@#/(\\/|[^/])*/i?@#//@g' $(CONVDIR)/$$f; \
	done
	xgettext -d$(PACKAGE) -LScheme -k'$$$$' -o$(PACKAGE).pot \
	         --copyright-holder='Shiro Kawai' \
	         --msgid-bugs-address='@PACKAGE_BUGREPORT@' \
	         $(POTFILES:%=$(CONVDIR)/%)
	sed -i -e '/^"Report-Msgid-Bugs-To:/d' $(PACKAGE).pot

update-po: generate-pot
	for lingua in $(ALL_LINGUAS); do \
	  if [ ! -r $$lingua.po ]; \
	    then cp $(PACKAGE).pot $$lingua.po; \
	    else  msgmerge -U $$lingua.po $(PACKAGE).pot; \
	  fi; \
	done

install : $(MO_FILES)
	for lingua in $(ALL_LINGUAS); do \
	  $(INSTALL) -d $(MSGDIR); \
	  $(INSTALL) -m 444 $$lingua.gmo $(MSGDIR)/$(PACKAGE).mo; \
	done

uninstall :
	for lingua in $(ALL_LINGUAS); do \
	  $(INSTALL) -U $(MSGDIR) $(PACKAGE).mo; \
	done

# NB: We don't remove *.gmo files by 'clean', since we want to
# include them in the distribution tarball---the target environment
# may not have msgfmt, or have an older version which might cause
# a problem.  (msgfmt 0.10.40 doesn't handle encoding info well.)
clean:
	rm -f $(PACKAGE).pot *~
	rm -fr $(CONVDIR)

distclean: clean
	rm -f Makefile

maintainer-clean: clean
	rm -f Makefile *.gmo 

